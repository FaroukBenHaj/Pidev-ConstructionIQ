{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/medfa/Desktop/Cycle_ingenieur/Esprit/4SAE5/Projet_PI/Pidev-ConstructionIQ/FrontEnd/Dashboard/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport Keycloak from \"keycloak-js\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nexport class KeycloakService {\n  constructor(router) {\n    this.router = router;\n  }\n  get keycloak() {\n    if (!this._keycloak) {\n      this._keycloak = new Keycloak({\n        url: 'http://localhost:9090',\n        realm: 'Esprit-project',\n        clientId: 'Pidev-ConstructionIQ'\n      });\n    }\n    return this._keycloak;\n  }\n  get profile() {\n    return this._profile;\n  }\n  init() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      try {\n        const authenticated = yield _this.keycloak.init({\n          onLoad: 'login-required',\n          pkceMethod: 'S256',\n          checkLoginIframe: false\n        });\n        if (authenticated) {\n          _this._profile = yield _this.keycloak.loadUserProfile();\n          _this._profile.token = _this.keycloak.token;\n          yield _this.updateToken();\n          return true;\n        }\n        return false;\n      } catch (error) {\n        console.error('Keycloak initialization failed:', error);\n        _this.router.navigate(['/login']);\n        return false;\n      }\n    })();\n  }\n  updateToken(minValidity = 30) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      try {\n        return yield _this2.keycloak.updateToken(minValidity);\n      } catch (error) {\n        console.error('Failed to refresh token:', error);\n        return false;\n      }\n    })();\n  }\n  login() {\n    return this.keycloak?.login();\n  }\n  logout() {\n    return this.keycloak?.logout({\n      redirectUri: window.location.origin\n    });\n  }\n  isAdmin() {\n    return this.keycloak.hasRealmRole('ADMIN') || false;\n  }\n  isUser() {\n    return this.keycloak.hasRealmRole('USER') || false;\n  }\n  getToken() {\n    return this.keycloak?.token || '';\n  }\n  getRoles() {\n    return this.keycloak.tokenParsed?.realm_access?.roles || [];\n  }\n  static {\n    this.ɵfac = function KeycloakService_Factory(t) {\n      return new (t || KeycloakService)(i0.ɵɵinject(i1.Router));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: KeycloakService,\n      factory: KeycloakService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["Keycloak","KeycloakService","constructor","router","keycloak","_keycloak","url","realm","clientId","profile","_profile","init","_this","_asyncToGenerator","authenticated","onLoad","pkceMethod","checkLoginIframe","loadUserProfile","token","updateToken","error","console","navigate","minValidity","_this2","login","logout","redirectUri","window","location","origin","isAdmin","hasRealmRole","isUser","getToken","getRoles","tokenParsed","realm_access","roles","i0","ɵɵinject","i1","Router","factory","ɵfac","providedIn"],"sources":["C:\\Users\\medfa\\Desktop\\Cycle_ingenieur\\Esprit\\4SAE5\\Projet_PI\\Pidev-ConstructionIQ\\FrontEnd\\Dashboard\\src\\app\\Services\\keycloak\\keycloak.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { UserProfile } from \"./user-profile\";\nimport { Router } from '@angular/router';\nimport Keycloak from \"keycloak-js\";\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class KeycloakService {\n  private _keycloak: Keycloak | undefined;\n  private _profile: UserProfile | undefined;\n\n  constructor(private router: Router) {}\n\n  get keycloak() {\n    if (!this._keycloak) {\n      this._keycloak = new Keycloak({\n        url: 'http://localhost:9090',\n        realm: 'Esprit-project',\n        clientId: 'Pidev-ConstructionIQ'\n      });\n    }\n    return this._keycloak;\n  }\n\n  get profile(): UserProfile | undefined {\n    return this._profile;\n  }\n\n  async init(): Promise<boolean> {\n    try {\n      const authenticated = await this.keycloak.init({\n        onLoad: 'login-required',\n        pkceMethod: 'S256',\n        checkLoginIframe: false\n      });\n\n      if (authenticated) {\n        this._profile = (await this.keycloak.loadUserProfile()) as UserProfile;\n        this._profile.token = this.keycloak.token;\n        await this.updateToken();\n        return true;\n      }\n      return false;\n    } catch (error) {\n      console.error('Keycloak initialization failed:', error);\n      this.router.navigate(['/login']);\n      return false;\n    }\n  }\n\n  async updateToken(minValidity = 30): Promise<boolean> {\n    try {\n      return await this.keycloak.updateToken(minValidity);\n    } catch (error) {\n      console.error('Failed to refresh token:', error);\n      return false;\n    }\n  }\n\n  login() {\n    return this.keycloak?.login();\n  }\n\n  logout() {\n    return this.keycloak?.logout({\n      redirectUri: window.location.origin\n    });\n  }\n\n  isAdmin(): boolean {\n    return this.keycloak.hasRealmRole('ADMIN') || false;\n  }\n\n  isUser(): boolean {\n    return this.keycloak.hasRealmRole('USER') || false;\n  }\n\n  getToken(): string {\n    return this.keycloak?.token || '';\n  }\n\n  getRoles(): string[] {\n    return this.keycloak.tokenParsed?.realm_access?.roles || [];\n  }\n}\n"],"mappings":";AAGA,OAAOA,QAAQ,MAAM,aAAa;;;AAKlC,OAAM,MAAOC,eAAe;EAI1BC,YAAoBC,MAAc;IAAd,KAAAA,MAAM,GAANA,MAAM;EAAW;EAErC,IAAIC,QAAQA,CAAA;IACV,IAAI,CAAC,IAAI,CAACC,SAAS,EAAE;MACnB,IAAI,CAACA,SAAS,GAAG,IAAIL,QAAQ,CAAC;QAC5BM,GAAG,EAAE,uBAAuB;QAC5BC,KAAK,EAAE,gBAAgB;QACvBC,QAAQ,EAAE;OACX,CAAC;;IAEJ,OAAO,IAAI,CAACH,SAAS;EACvB;EAEA,IAAII,OAAOA,CAAA;IACT,OAAO,IAAI,CAACC,QAAQ;EACtB;EAEMC,IAAIA,CAAA;IAAA,IAAAC,KAAA;IAAA,OAAAC,iBAAA;MACR,IAAI;QACF,MAAMC,aAAa,SAASF,KAAI,CAACR,QAAQ,CAACO,IAAI,CAAC;UAC7CI,MAAM,EAAE,gBAAgB;UACxBC,UAAU,EAAE,MAAM;UAClBC,gBAAgB,EAAE;SACnB,CAAC;QAEF,IAAIH,aAAa,EAAE;UACjBF,KAAI,CAACF,QAAQ,SAAUE,KAAI,CAACR,QAAQ,CAACc,eAAe,EAAkB;UACtEN,KAAI,CAACF,QAAQ,CAACS,KAAK,GAAGP,KAAI,CAACR,QAAQ,CAACe,KAAK;UACzC,MAAMP,KAAI,CAACQ,WAAW,EAAE;UACxB,OAAO,IAAI;;QAEb,OAAO,KAAK;OACb,CAAC,OAAOC,KAAK,EAAE;QACdC,OAAO,CAACD,KAAK,CAAC,iCAAiC,EAAEA,KAAK,CAAC;QACvDT,KAAI,CAACT,MAAM,CAACoB,QAAQ,CAAC,CAAC,QAAQ,CAAC,CAAC;QAChC,OAAO,KAAK;;IACb;EACH;EAEMH,WAAWA,CAACI,WAAW,GAAG,EAAE;IAAA,IAAAC,MAAA;IAAA,OAAAZ,iBAAA;MAChC,IAAI;QACF,aAAaY,MAAI,CAACrB,QAAQ,CAACgB,WAAW,CAACI,WAAW,CAAC;OACpD,CAAC,OAAOH,KAAK,EAAE;QACdC,OAAO,CAACD,KAAK,CAAC,0BAA0B,EAAEA,KAAK,CAAC;QAChD,OAAO,KAAK;;IACb;EACH;EAEAK,KAAKA,CAAA;IACH,OAAO,IAAI,CAACtB,QAAQ,EAAEsB,KAAK,EAAE;EAC/B;EAEAC,MAAMA,CAAA;IACJ,OAAO,IAAI,CAACvB,QAAQ,EAAEuB,MAAM,CAAC;MAC3BC,WAAW,EAAEC,MAAM,CAACC,QAAQ,CAACC;KAC9B,CAAC;EACJ;EAEAC,OAAOA,CAAA;IACL,OAAO,IAAI,CAAC5B,QAAQ,CAAC6B,YAAY,CAAC,OAAO,CAAC,IAAI,KAAK;EACrD;EAEAC,MAAMA,CAAA;IACJ,OAAO,IAAI,CAAC9B,QAAQ,CAAC6B,YAAY,CAAC,MAAM,CAAC,IAAI,KAAK;EACpD;EAEAE,QAAQA,CAAA;IACN,OAAO,IAAI,CAAC/B,QAAQ,EAAEe,KAAK,IAAI,EAAE;EACnC;EAEAiB,QAAQA,CAAA;IACN,OAAO,IAAI,CAAChC,QAAQ,CAACiC,WAAW,EAAEC,YAAY,EAAEC,KAAK,IAAI,EAAE;EAC7D;;;uBA5EWtC,eAAe,EAAAuC,EAAA,CAAAC,QAAA,CAAAC,EAAA,CAAAC,MAAA;IAAA;EAAA;;;aAAf1C,eAAe;MAAA2C,OAAA,EAAf3C,eAAe,CAAA4C,IAAA;MAAAC,UAAA,EAFd;IAAM;EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}